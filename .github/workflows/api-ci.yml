name: api-ci

on:
  push:
    branches: [ main ]           # solo main
  workflow_dispatch:

permissions:
  contents: read
  packages: write

concurrency:
  group: fastfood-api-${{ github.ref }}
  cancel-in-progress: true

env:
  MODULE: bootstrap

jobs:
  build-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache Maven repo
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: m2-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: m2-${{ runner.os }}-

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Build JAR (solo módulo bootstrap)
        run: ./mvnw -B -DskipTests -pl bootstrap -am clean package

      - name: Smoke check controller dentro del JAR
        run: |
          set -e
          JAR=bootstrap/target/app.jar
          # 1) validar que el fat-jar exista
          test -f "$JAR" || (echo "❌ No existe $JAR" && exit 1)

          # 2) extraer el jar anidado del módulo infrastructure
          TMPDIR=$(mktemp -d)
          unzip -q "$JAR" 'BOOT-INF/lib/*infrastructure*.jar' -d "$TMPDIR" || true
          INF_JAR=$(find "$TMPDIR" -type f -name '*infrastructure*.jar' | head -n1)

          if [ -z "$INF_JAR" ]; then
            echo "❌ No se encontró el jar de infrastructure dentro de BOOT-INF/lib"
            echo "Contenido de BOOT-INF/lib:"
            unzip -l "$JAR" BOOT-INF/lib/\*.jar || true
            exit 1
          fi

          echo "Infra jar: $INF_JAR"
          # 3) buscar el controller dentro del jar anidado
          jar tf "$INF_JAR" | grep -qi 'ec/com/erre/fastfood/infrastructure/api/in/rest/GrupoIngredienteController' \
            && echo "✅ Controller encontrado dentro del JAR anidado" \
            || (echo "❌ Controller NO está dentro de $INF_JAR" && exit 1)


      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute metadata
        id: meta
        run: |
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          IMAGE="ghcr.io/${OWNER}/fastfood-api"
          SHORT=${GITHUB_SHA::7}
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "tags=$IMAGE:dev,$IMAGE:sha-$SHORT" >> $GITHUB_OUTPUT
          {
            echo "labels=org.opencontainers.image.source=${{ github.repository }}";
            echo "org.opencontainers.image.revision=${GITHUB_SHA}";
            echo "org.opencontainers.image.created=$(date -u +%FT%TZ)";
          } >> $GITHUB_OUTPUT

      - name: Build & push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            MODULE=${{ env.MODULE }}
            BUILD_SHA=${{ github.sha }}
            CACHE_BUSTER=${{ github.run_id }}   # fuerza recompilar capa del JAR
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-dev:
    needs: build-push
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -euo pipefail
            echo "== Pull + recreate =="
            sudo docker compose -f /opt/apps/stack/docker-compose.yml pull --quiet api-fastfood
            sudo docker compose -f /opt/apps/stack/docker-compose.yml up -d --no-deps --force-recreate api-fastfood

            echo "== Versión corriendo =="
            IMG=$(sudo docker ps --format '{{.Image}}' --filter 'name=api-fastfood')
            echo "Image: $IMG"
            sudo docker run --rm "$IMG" sh -lc 'jar tf /opt/app/app.jar | grep -i "GrupoIngredienteController" | head -n1 || true'

            echo "== Mappings expuestos =="
            curl -s http://127.0.0.1:8090/fastfood/api/actuator/mappings | grep -i grupo-ingredientes || (echo "No se ve el endpoint" && exit 1)

            echo "== Health =="
            curl -k --fail https://api.erre.com/fastfood/api/actuator/health
