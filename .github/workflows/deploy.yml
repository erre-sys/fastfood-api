name: API - Deploy

on:
  workflow_run:
    workflows: ["API - CI"]
    types: [completed]

permissions:
  contents: read
  packages: read

concurrency:
  group: api-deploy-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

env:
  INFRA_DIR: /opt/palaspapas/infra
  COMPOSE_SERVICE: api
  IMAGE_NAME: fastfood-api

jobs:
  deploy_develop:
    name: Deploy API -> develop (laptop)
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'develop'
    runs-on: [self-hosted, develop]
    environment: develop
    steps:
      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull & Restart API (develop)
        shell: bash
        run: |
          set -euo pipefail
          OWNER_LC="$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')"
          SHORT_SHA="$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)"
          TAG="ghcr.io/${OWNER_LC}/${IMAGE_NAME}:sha-${SHORT_SHA}"

          cd "${INFRA_DIR}"

          export IMAGE_TAG="${TAG##*:}"
          docker compose pull "${COMPOSE_SERVICE}"
          docker compose up -d --force-recreate --no-deps "${COMPOSE_SERVICE}"

          docker image prune -f || true
          docker builder prune -f || true

  deploy_prod:
    name: Deploy API -> prod (prod)
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: [self-hosted, prod]
    environment: production
    steps:
      - name: Login GHCR (pull)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull & Restart API (prod)
        shell: bash
        run: |
          set -euo pipefail
          OWNER_LC="$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')"
          SHORT_SHA="$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)"
          TAG="ghcr.io/${OWNER_LC}/${IMAGE_NAME}:sha-${SHORT_SHA}"

          cd "${INFRA_DIR}"

          export IMAGE_TAG="${TAG##*:}"
          docker compose pull "${COMPOSE_SERVICE}"
          docker compose up -d --force-recreate --no-deps "${COMPOSE_SERVICE}"

          docker image prune -f || true
          docker builder prune -f || true
