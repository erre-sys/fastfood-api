name: api-deploy

on:
  workflow_run:
    workflows: ["api-ci"]
    types: [completed]

permissions:
  contents: read
  packages: read

concurrency:
  group: api-deploy-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

jobs:
  deploy-develop:
    name: deploy-develop (self-hosted)
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'develop' }}
    runs-on: self-hosted
    steps:
      - name: Login a GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy API en develop
        env:
          INFRA_DIR: /opt/palaspapas/infra
          COMPOSE_SERVICE: api
          IMAGE: ghcr.io/${{ github.repository_owner }}/fastfood-api
          SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          set -euo pipefail
          cd "${INFRA_DIR}"
          SHORT_SHA="$(echo "${SHA}" | cut -c1-7)"
          TAG="${IMAGE}:sha-${SHORT_SHA}"

          TAG_VALUE="${TAG##*:}"
          export IMAGE_TAG="${TAG_VALUE}"

          docker compose pull "${COMPOSE_SERVICE}"
          docker compose up -d --force-recreate --no-deps "${COMPOSE_SERVICE}"

          docker image prune -f || true
          docker builder prune -f || true

  deploy-prod:
    name: deploy-prod (self-hosted)
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    runs-on: self-hosted
    steps:
      - name: Login a GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy API en prod
        env:
          INFRA_DIR: /opt/palaspapas/infra
          COMPOSE_SERVICE: api
          IMAGE: ghcr.io/${{ github.repository_owner }}/fastfood-api
          SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          set -euo pipefail
          cd "${INFRA_DIR}"
          SHORT_SHA="$(echo "${SHA}" | cut -c1-7)"
          TAG="${IMAGE}:sha-${SHORT_SHA}"

          TAG_VALUE="${TAG##*:}"
          export IMAGE_TAG="${TAG_VALUE}"

          docker compose pull "${COMPOSE_SERVICE}"
          docker compose up -d --force-recreate --no-deps "${COMPOSE_SERVICE}"

          docker image prune -f || true
          docker builder prune -f || true
